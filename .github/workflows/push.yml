name: CI
on: [push, pull_request]
jobs:
  black:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"
      - run: pip install --group format
      - run: black --check .

  mypy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"
      - run: pip install ".[all]" --group type-check
      - run: mypy

  isort:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"
      - run: pip install --group lint
      - run: isort --check dramatiq tests

  flake8:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"
      - run: pip install --group lint
      - run: flake8 dramatiq tests examples

  documentation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"
      - run: pip install ".[all]" --group docs
      - run: cd docs && make html

  test:
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-24.04"]
        python: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        concurrency: ["cpython", "free-threaded", "gevent"]
        exclude:
          - python: "3.10"
            concurrency: "free-threaded"
          - python: "3.11"
            concurrency: "free-threaded"
          - python: "3.12"
            concurrency: "free-threaded"
          - python: "3.13"
            concurrency: "free-threaded"

    runs-on: ${{ matrix.os }}
    name: test on ${{ matrix.python }} (${{ matrix.os }}, ${{ matrix.concurrency }})

    services:
      memcached:
        image: memcached:latest
        ports:
          - 11211:11211
      rabbitmq:
        image: rabbitmq:3
        env:
          RABBITMQ_DEFAULT_USER: "dramatiq"
          RABBITMQ_DEFAULT_PASS: "dramatiq"
        ports:
          - 5672:5672
        options: '--hostname "rmq" --health-cmd "rabbitmqctl status" --health-interval 10s --health-timeout 10s --health-retries 3 --health-start-period 60s'
      redis:
        image: redis:latest
        ports:
          - 6379:6379

    env:
      RABBITMQ_USERNAME: "dramatiq"
      RABBITMQ_PASSWORD: "dramatiq"

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ matrix.python }}
          freethreaded: ${{ matrix.concurrency == 'free-threaded' }}
      - run: |
          sudo apt-get update
          sudo apt-get remove libhashkit2 libmemcached11 || true
          sudo apt-get install -y libmemcached-dev

      - run: pip install -e '.[rabbitmq,redis,memcached,prometheus]' --group test
        if: ${{ matrix.concurrency == 'cpython' || matrix.concurrency == 'free-threaded' }}
      - run: pip install -e '.[rabbitmq,redis,memcached,prometheus,gevent]' --group test
        if: ${{ matrix.concurrency == 'gevent' }}

      - name: "Run tests"
        run: pytest --benchmark-skip
        if: ${{ matrix.concurrency == 'cpython' }}
      - name: "Run tests with free-threaded python"
        run: pytest --benchmark-skip
        env:
          # Force the GIl to remain disabled, in case a dependency tries to enable it.
          # https://docs.python.org/3/using/cmdline.html#envvar-PYTHON_GIL
          PYTHON_GIL: 0
        if: ${{ matrix.concurrency == 'free-threaded' }}
      - name: "Run tests with gevent"
        run: python pytest-gevent.py --benchmark-skip
        if: ${{ matrix.concurrency == 'gevent' }}
